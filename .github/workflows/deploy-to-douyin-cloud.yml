name: éƒ¨ç½²åˆ°æŠ–éŸ³äº‘

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: è¿è¡Œæµ‹è¯•
      run: npm test
      
    - name: æ„å»ºé¡¹ç›®
      run: npm run build --if-present
      
    - name: éƒ¨ç½²åˆ°æŠ–éŸ³äº‘
      env:
        DOUYIN_CLOUD_TOKEN: ${{ secrets.DOUYIN_CLOUD_TOKEN }}
        DOUYIN_CLOUD_APP_ID: ${{ secrets.DOUYIN_CLOUD_APP_ID }}
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°æŠ–éŸ³äº‘..."
        echo "åº”ç”¨ID: $DOUYIN_CLOUD_APP_ID"
        
        # è¿™é‡Œéœ€è¦æ ¹æ®æŠ–éŸ³äº‘çš„å®é™…éƒ¨ç½²APIè¿›è¡Œè°ƒæ•´
        # ç›®å‰ä½¿ç”¨æ¨¡æ‹Ÿéƒ¨ç½²æµç¨‹
        
        echo "ğŸ“¦ å‡†å¤‡éƒ¨ç½²åŒ…..."
        tar -czf deploy.tar.gz --exclude=node_modules --exclude=.git .
        
        echo "â˜ï¸ ä¸Šä¼ åˆ°æŠ–éŸ³äº‘..."
        # curl -X POST "https://api.douyin-cloud.com/deploy" \
        #   -H "Authorization: Bearer $DOUYIN_CLOUD_TOKEN" \
        #   -H "Content-Type: application/octet-stream" \
        #   -F "file=@deploy.tar.gz" \
        #   -F "app_id=$DOUYIN_CLOUD_APP_ID"
        
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "ğŸ”— æœåŠ¡åœ°å€: https://your-app.douyin-cloud.com"
        
    - name: å¥åº·æ£€æŸ¥
      run: |
        echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 30
        
        # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
        # curl -f https://your-app.douyin-cloud.com/health || exit 1
        
        echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
        
    - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“± YJKZ WebSocketæœåŠ¡å·²æˆåŠŸéƒ¨ç½²åˆ°æŠ–éŸ³äº‘"
          echo "ğŸ”— è®¿é—®åœ°å€: https://your-app.douyin-cloud.com"
          echo "ğŸ’š å¥åº·æ£€æŸ¥: https://your-app.douyin-cloud.com/health"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶é‡è¯•éƒ¨ç½²"
        fi